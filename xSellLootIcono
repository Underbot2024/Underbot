setDefaultTab("Target")

if not storage.ItemsToSell or not storage.ItemsToSell.items then
    storage.ItemsToSell = {
        items = {

        },
        hide = true
    }
end

local config = storage.ItemsToSell

local ItemsToSellContainer

UI.Button("Items To Sell", function ()
    config.hide = not config.hide
    ItemsToSellContainer:setVisible(config.hide)
end)

ItemsToSellContainer = UI.Container(function(widget, items)
  config.items = table.collect(items, function (key, value)
        return value.id
  end)
end, true)
ItemsToSellContainer:setVisible(config.hide)
ItemsToSellContainer:setItems(config.items)

local npcWindow = modules.game_npctrade.npcWindow


function sellLoot()
    NPC.say("hi")
    schedule(1000, function ()
        NPC.say("trade")
    end)

    schedule(3000, function ()
        if npcWindow:isHidden() then return end
        for _, value in ipairs(ItemsToSellContainer:getItems()) do
            NPC.sell(value.id, -1, true)
        end
        schedule(3000, function ()
            NPC.closeTrade()
        end)
    end)
end

local function activeDrag(icon, nameMacro, position)
  icon:breakAnchors()
  icon:move(position.posX or 20, position.posY or 20)

  local dobleclick = false
  icon.onDoubleClick = function()
    dobleclick = true
    schedule(1500, function()
      dobleclick = false
    end)
  end

  icon.onDragEnter = function(widget, mousePos)
    if not dobleclick and not g_keyboard.isKeyPressed("F1") then
      return false
    end
    icon:breakAnchors()
    icon.movingReference = { x = mousePos.x - icon:getX(), y = mousePos.y - icon:getY() }
    dobleclick = false
    return true
  end

  icon.onDragMove = function(widget, mousePos, moved)
    local parentRect = widget:getParent():getRect()
    local x = math.min(math.max(0,mousePos.x - widget.movingReference.x), parentRect.x + parentRect.width - widget:getWidth())
    local y = math.min(math.max(0,mousePos.y - widget.movingReference.y), parentRect.y + parentRect.height - widget:getHeight())
    widget:move(x, y)
    icon.moving = { x = icon:getX(), y = icon:getY() }
    return true
  end

  icon.onDragLeave = function(widget, pos)
    storage[nameMacro] = { posX = icon.moving.x, posY = icon.moving.y }
  end
end

local selloIcon = addIcon("Selloot", {item = 5675, text= "Loot", switchable = false}, function (widget)
   sellLoot()
end)

selloIcon.text:setFont('verdana-11px-rounded')

activeDrag(selloIcon, 'sello', storage.sello or {})

setDefaultTab("MACRO")

-- Exori
macro(1200, "Exori", function()
if g_game.isAttacking() then
saySpell('exori', 200)
end
end)

-- Exori Mas
macro(1200, "Exori Mas", function()
if g_game.isAttacking() then
saySpell('exori mas', 200)
end
end)

-- Utito Tempo
macro(250, "Utito Tempo", function()
  if not hasPartyBuff() then
    say("Utito tempo")
  end
end)

-- Utito tempo cerca de 2 monster o mas
local config = {
    spell = "Utito tempo",
    distance = 1,
}

macro(300, "Utito Tempo Pro", function()
    if hasPartyBuff() then
        return
    end

    local playerPosition = g_game.getLocalPlayer():getPosition()
    local monstersScreen = g_map.getSpectators(playerPosition, false) 
    local monsterCount = 0

    for _, creature in ipairs(monstersScreen) do
        if creature:isMonster() then
            local creaturePosition = creature:getPosition()
            local distance = math.max(math.abs(creaturePosition.x - playerPosition.x), 
                math.abs(creaturePosition.y - playerPosition.y))
            if distance <= config.distance then
                monsterCount = monsterCount + 1
            end
        end
    end

    if monsterCount >= 2 then
        say(config.spell)
    end
end)

-- Softboots
local softboots = macro(2000,"Recarga Soft", function ()
say("!softboots")
end)

--Ataca al que te saque pk
local attacker
local targetTime

local attackPK = macro(500, "Attack PK", nil, function()
  if attacker then
    if attacker:getPosition() and attacker:getPosition().z == posz() then
      if g_game.isAttacking() then
        if g_game.getAttackingCreature():getName() ~= attacker:getName() then
          g_game.attack(attacker)
        end
      else
        g_game.attack(attacker)
      end
    end
  else
    if not g_game.isAttacking() then
      TargetBot.setOn()
      CaveBot.setOn()
    end
  end
  if targetTime then
    if now - targetTime > 2500 then
      attacker = nil
    end
  end
end)

onMissle(function(missle)
  if attackPK.isOn() then
    local src = missle:getSource()
    if src.z ~= posz() then
      return
    end
    local shooterTile = g_map.getTile(src)
    if shooterTile then
      local creatures = shooterTile:getCreatures()
      if creatures[1] then
        if creatures[1]:isPlayer() then
          local destination = missle:getDestination()
          if posx() == destination.x and posy() == destination.y then
            if player:getName() ~= creatures[1]:getName() then
              if creatures[1]:getSkull() ~= 0 and attacker ~= creatures[1] then
                attacker = creatures[1]
                targetTime = now
                TargetBot.setOff()
              end
            end
          end
        end
      end
    end
  end
end)

-- Face monster
macro(100, "Face Monster", function()
    local target = g_game.getAttackingCreature()
    if target then
        local playerPos = player:getPosition()
        local targetPos = target:getPosition()

        local xDiff = targetPos.x - playerPos.x
        local yDiff = targetPos.y - playerPos.y

        if math.abs(xDiff) > math.abs(yDiff) then
            if xDiff > 0 then
                player:setDirection(1)
            else
                player:setDirection(3)
            end
        else
            if yDiff > 0 then
                player:setDirection(2)
            else
                player:setDirection(0)
            end
        end

        local newPos = {x = playerPos.x, y = playerPos.y, z = playerPos.z}

        if math.abs(xDiff) > math.abs(yDiff) then
            newPos.y = playerPos.y
            newPos.x = playerPos.x + (xDiff > 0 and 1 or -1)
        else
            newPos.x = playerPos.x
            newPos.y = playerPos.y + (yDiff > 0 and 1 or -1)
        end

        if playerPos.x ~= newPos.x or playerPos.y ~= newPos.y then
            local tile = g_map.getTile(newPos)
            if tile and tile:isWalkable() then
                autoWalk(newPos)
            end
        end
    end
end)

-- Multispell no antipk
local distance = 2
local amountOfMonsters = 2
macro(1200, "Multi Target Spell",  function()
   local specAmount = 0
   if not g_game.isAttacking() then
       return
   end
   for i,mob in ipairs(getSpectators()) do
       if (getDistanceBetween(player:getPosition(), mob:getPosition())  <= distance and mob:isMonster())  then
           specAmount = specAmount + 1
       end
   end
   if (specAmount >= amountOfMonsters) then
       say(storage.Spell2, 250)
   else
       say(storage.Spell1, 250)
   end
end)
addTextEdit("Spell1", storage.Spell1 or "Single target", function(widget, text)
storage.Spell1 = text
end)
addTextEdit("Spell2", storage.Spell2 or "Multi target", function(widget, text)
storage.Spell2 = text
end)

-- Script By Asking
local targeting = macro(500, "Target Inteligente", function()
    if isInPz() then
        targetMonster = nil
        return
    end

    local playerPos = player:getPosition()


    local battlelist = getSpectators()

    local ignoreSet = {}
    local ignoreText = storage.Mobs or ""
    local monsterNames = string.split(ignoreText, ",")

    for _, name in ipairs(monsterNames) do
        ignoreSet[name:trim()] = true
    end

    local currentTarget = g_game.getAttackingCreature()
    local targetMonster = nil
    local closestDistance = tonumber(storage.Range)
    local lowestHealthPercent = 101

    local validTargets = {}

    for _, val in pairs(battlelist) do
        if val:isMonster() and not ignoreSet[val:getName()] then
            local distance = getDistanceBetween(playerPos, val:getPosition())
            if distance <= closestDistance and val:canShoot(closestDistance) then
                table.insert(validTargets, val)
            end
        end
    end


    for _, val in ipairs(validTargets) do
        local healthPercent = val:getHealthPercent()
        if healthPercent < lowestHealthPercent or currentTarget == val then
            lowestHealthPercent = healthPercent
            targetMonster = val
        end
    end


    if targetMonster and currentTarget ~= targetMonster then
        g_game.attack(targetMonster)
    end
end)

local function activeDrag(icon, nameMacro, position)
  icon:breakAnchors()
  icon:move(position.posX or 20, position.posY or 20)

  local dobleclick = false
  icon.onDoubleClick = function()
    dobleclick = true
    schedule(1500, function()
      dobleclick = false
    end)
  end

  icon.onDragEnter = function(widget, mousePos)
    if not dobleclick and not g_keyboard.isKeyPressed("F1") then
      return false
    end
    icon:breakAnchors()
    icon.movingReference = { x = mousePos.x - icon:getX(), y = mousePos.y - icon:getY() }
    dobleclick = false
    return true
  end

  icon.onDragMove = function(widget, mousePos, moved)
    local parentRect = widget:getParent():getRect()
    local x = math.min(math.max(0,mousePos.x - widget.movingReference.x), parentRect.x + parentRect.width - widget:getWidth())
    local y = math.min(math.max(0,mousePos.y - widget.movingReference.y), parentRect.y + parentRect.height - widget:getHeight())
    widget:move(x, y)
    icon.moving = { x = icon:getX(), y = icon:getY() }
    return true
  end

  icon.onDragLeave = function(widget, pos)
    storage[nameMacro] = { posX = icon.moving.x, posY = icon.moving.y }
  end
end

local targeting = addIcon("targeting", {item = 10800, text = "Attack", switchable = true, moveable = true}, function(icon, isOn)
targeting.setOn(isOn)
end)

targeting.text:setFont('verdana-11px-rounded')

activeDrag(targeting, 'targeting', storage.targeting or {})

UI.Label("Monster a Ignorar")
UI.TextEdit(storage.Mobs or "monster1, monster2, monster3", function(widget, text)
    storage.Mobs = text
end)

UI.Label("Distancia Maxima a Revisar")
UI.TextEdit(storage.Range or "10", function(widget, text)
    local range = tonumber(text)
    if range then
        storage.Range = range
    else
        modules.game_textmessage.displayGameMessage("[Error] Ingrese un numero valido para la distancia maxima.")
    end
end)
UI.Separator()
local moneyIds = {3031, 3035} -- gold coin, platinium coin
macro(1000, "Exchange money", function()
  local containers = g_game.getContainers()
  for index, container in pairs(containers) do
    if not container.lootContainer then -- ignore monster containers
      for i, item in ipairs(container:getItems()) do
        if item:getCount() == 100 then
          for m, moneyId in ipairs(moneyIds) do
            if item:getId() == moneyId then
              return g_game.use(item)            
            end
          end
        end
      end
    end
  end
end)
UI.Separator()
UI.Label("Mana Training")
if type(storage.manaTrain) ~= "table" then
  storage.manaTrain = {on=false, title="MP%", text="utevo lux", min=80, max=100}
end

local manatrainmacro = macro(1000, function()
  if TargetBot and TargetBot.isActive() then return end -- pause when attacking
  local mana = math.min(100, math.floor(100 * (player:getMana() / player:getMaxMana())))
  if storage.manaTrain.max >= mana and mana >= storage.manaTrain.min then
    say(storage.manaTrain.text)
  end
end)
manatrainmacro.setOn(storage.manaTrain.on)

UI.DualScrollPanel(storage.manaTrain, function(widget, newParams) 
  storage.manaTrain = newParams
  manatrainmacro.setOn(storage.manaTrain.on)
end)
UI.Separator()
